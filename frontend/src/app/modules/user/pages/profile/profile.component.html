<div class="profile-page">
  <mat-card class="profile-card mat-elevation-z6">
    <div class="profile-grid">

      <div class="left-col">
        <div class="avatar-wrap" [class.editing]="editing">
          <img [src]="avatarPreview || user?.avatar || defaultAvatar" alt="avatar" class="avatar" />
          <div class="avatar-overlay" *ngIf="editing">
            <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)" hidden />
            <button mat-mini-fab color="primary" (click)="fileInput.click()" aria-label="Upload avatar">
              <mat-icon>camera_alt</mat-icon>
            </button>
            <button *ngIf="avatarPreview" mat-mini-fab color="warn" (click)="removeAvatar()" aria-label="Remove avatar">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div class="user-basic">
          <h2 class="name">{{ user?.username || 'User' }}</h2>
          <p class="role">{{ user?.role | titlecase }}</p>
          <div class="contact">
            <div><mat-icon>email</mat-icon> <small>{{ user?.email }}</small></div>
            <div><mat-icon>phone</mat-icon> <small>{{ user?.mobileNumber || '-' }}</small></div>
          </div>
        </div>

        <div class="quick-actions" *ngIf="!editing">
          <button mat-stroked-button color="primary" (click)="startEdit()">Edit Profile</button>
          <button mat-button (click)="openChangePassword()">Change Password</button>
        </div>
      </div>

      <!-- RIGHT: Form -->
      <div class="right-col">
        <form [formGroup]="form" (ngSubmit)="onSave()" class="profile-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full">
              <mat-label>Username</mat-label>
              <input matInput formControlName="username" />
              <mat-error *ngIf="fc.username.hasError('required')">Username is required</mat-error>
              <mat-error *ngIf="fc.username.hasError('minlength')">Min 3 characters</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" />
              <mat-error *ngIf="fc.email.hasError('required')">Email is required</mat-error>
              <mat-error *ngIf="fc.email.hasError('email')">Invalid email</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half">
              <mat-label>Mobile</mat-label>
              <input matInput formControlName="mobileNumber" />
              <mat-error *ngIf="fc.mobileNumber.hasError('minlength')">Invalid number</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row" *ngIf="editing">
            <mat-form-field appearance="outline" class="full">
              <mat-label>Display Bio (optional)</mat-label>
              <textarea matInput formControlName="bio" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid || saving">
              <mat-spinner *ngIf="saving" diameter="20"></mat-spinner>
              <span *ngIf="!saving">Save Changes</span>
            </button>
            <button mat-button type="button" (click)="cancel()" [disabled]="saving">Cancel</button>
          </div>
        </form>
      </div>

    </div>
  </mat-card>
</div>
